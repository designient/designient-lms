generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  STUDENT
  INSTRUCTOR
  ADMIN
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ContentType {
  TEXT
  VIDEO
  FILE
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
}

enum SubmissionStatus {
  SUBMITTED
  GRADED
  RESUBMITTED
}

enum ProgramStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum CohortStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum StudentStatus {
  INVITED
  ACTIVE
  FLAGGED
  DROPPED
  COMPLETED
}

enum MentorStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum MessageChannel {
  EMAIL
  WHATSAPP
  SMS
}

enum MessageStatus {
  DRAFT
  SCHEDULED
  SENT
  FAILED
  CANCELLED
}

enum RecipientType {
  INDIVIDUAL
  COHORT
  ALL_STUDENTS
  ALL_MENTORS
  CUSTOM
}

enum SubscriptionPlan {
  FREE
  STARTER
  GROWTH
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELLED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  passwordHash  String   @map("password_hash")
  role          Role     @default(STUDENT)
  isActive      Boolean  @default(true) @map("is_active")
  emailVerified Boolean  @default(false) @map("email_verified")
  resetToken    String?  @map("reset_token")
  resetTokenExp DateTime? @map("reset_token_exp")
  verifyToken   String?  @map("verify_token")
  avatarUrl     String?  @map("avatar_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  courses       Course[]        @relation("CourseCreator")
  enrollments   Enrollment[]
  lessonProgress LessonProgress[]
  submissions   Submission[]
  grades        Grade[]         @relation("Grader")
  assignments   Assignment[]    @relation("AssignmentCreator")
  auditLogs     AuditLog[]
  studentProfile StudentProfile?
  mentorProfile MentorProfile?
  sentMessages  Message[]
  studentNotes  StudentNote[]

  @@map("users")
}

model Course {
  id          String      @id @default(cuid())
  title       String
  slug        String      @unique
  description String?
  level       CourseLevel @default(BEGINNER)
  isPublished Boolean     @default(false) @map("is_published")
  createdBy   String      @map("created_by")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  creator     User        @relation("CourseCreator", fields: [createdBy], references: [id])
  modules     Module[]
  enrollments Enrollment[]
  assignments Assignment[]

  @@index([createdBy])
  @@index([isPublished])
  @@index([createdAt])
  @@map("courses")
}

model Module {
  id        String   @id @default(cuid())
  courseId   String   @map("course_id")
  title     String
  position  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons   Lesson[]
  assignments Assignment[]

  @@index([courseId])
  @@map("modules")
}

model Lesson {
  id          String      @id @default(cuid())
  moduleId    String      @map("module_id")
  title       String
  contentType ContentType @map("content_type")
  contentBody String?     @map("content_body")
  position    Int         @default(0)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  module      Module      @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress    LessonProgress[]

  @@index([moduleId])
  @@map("lessons")
}

model Enrollment {
  id         String           @id @default(cuid())
  userId     String           @map("user_id")
  courseId    String           @map("course_id")
  enrolledAt DateTime         @default(now()) @map("enrolled_at")
  status     EnrollmentStatus @default(ACTIVE)

  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course     Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("enrollments")
}

model LessonProgress {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  lessonId    String   @map("lesson_id")
  completedAt DateTime @default(now()) @map("completed_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@map("lesson_progress")
}

model Assignment {
  id          String   @id @default(cuid())
  courseId     String   @map("course_id")
  moduleId    String?  @map("module_id")
  title       String
  description String?
  dueAt       DateTime? @map("due_at")
  maxScore    Int      @default(100) @map("max_score")
  isPublished Boolean  @default(false) @map("is_published")
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  module      Module?  @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  creator     User     @relation("AssignmentCreator", fields: [createdBy], references: [id])
  submissions Submission[]

  @@index([courseId])
  @@index([moduleId])
  @@index([createdBy])
  @@map("assignments")
}

model Submission {
  id           String           @id @default(cuid())
  assignmentId String           @map("assignment_id")
  studentId    String           @map("student_id")
  fileUrl      String           @map("file_url")
  notes        String?
  attemptNo    Int              @default(1) @map("attempt_no")
  submittedAt  DateTime         @default(now()) @map("submitted_at")
  status       SubmissionStatus @default(SUBMITTED)

  assignment   Assignment       @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student      User             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  grade        Grade?

  @@index([assignmentId])
  @@index([studentId])
  @@index([submittedAt])
  @@map("submissions")
}

model Grade {
  id           String   @id @default(cuid())
  submissionId String   @unique @map("submission_id")
  gradedBy     String   @map("graded_by")
  score        Int
  feedback     String?
  gradedAt     DateTime @default(now()) @map("graded_at")

  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  grader       User       @relation("Grader", fields: [gradedBy], references: [id])

  @@index([gradedBy])
  @@map("grades")
}

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String?  @map("actor_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  actor      User?    @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([actorId])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

model Program {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique
  description String?
  duration    String?
  status      ProgramStatus @default(DRAFT)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  cohorts     Cohort[]

  @@map("programs")
}

model Cohort {
  id                  String       @id @default(cuid())
  name                String
  programId           String       @map("program_id")
  startDate           DateTime     @map("start_date")
  endDate             DateTime?    @map("end_date")
  status              CohortStatus @default(UPCOMING)
  capacity            Int          @default(25)
  price               Float        @default(0)
  currency            String       @default("INR")
  description         String?
  enrollmentDeadline  DateTime?    @map("enrollment_deadline")
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  program   Program         @relation(fields: [programId], references: [id], onDelete: Cascade)
  students  StudentProfile[]
  mentors   MentorProfile[]

  @@index([programId])
  @@index([status])
  @@map("cohorts")
}

model StudentProfile {
  id             String        @id @default(cuid())
  userId         String        @unique @map("user_id")
  cohortId       String?       @map("cohort_id")
  status         StudentStatus @default(INVITED)
  phone          String?
  whatsappOptIn  Boolean       @default(true) @map("whatsapp_opt_in")
  enrollmentDate DateTime      @default(now()) @map("enrollment_date")
  
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  cohort         Cohort?       @relation(fields: [cohortId], references: [id], onDelete: SetNull)
  notes          StudentNote[]

  @@index([userId])
  @@index([cohortId])
  @@index([status])
  @@map("student_profiles")
}

model MentorProfile {
  id             String       @id @default(cuid())
  userId         String       @unique @map("user_id")
  status         MentorStatus @default(ACTIVE)
  specialization String?
  bio            String?
  maxCohorts     Int          @default(2) @map("max_cohorts")
  rating         Float        @default(0)
  
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  cohorts        Cohort[]

  @@index([userId])
  @@index([status])
  @@map("mentor_profiles")
}

model StudentNote {
  id        String   @id @default(cuid())
  studentId String   @map("student_id")
  authorId  String   @map("author_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  student   StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  author    User           @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([authorId])
  @@map("student_notes")
}

model Message {
  id             String         @id @default(cuid())
  subject        String
  body           String
  channel        MessageChannel @default(EMAIL)
  status         MessageStatus  @default(DRAFT)
  recipientType  RecipientType  @map("recipient_type")
  recipientCount Int            @default(0) @map("recipient_count")
  sentAt         DateTime?      @map("sent_at")
  scheduledAt    DateTime?      @map("scheduled_at")
  senderId       String         @map("sender_id")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  sender         User           @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([status])
  @@index([channel])
  @@map("messages")
}

model Settings {
  id               String   @id @default(cuid())
  orgName          String   @map("org_name")
  orgSlug          String   @unique @map("org_slug")
  supportEmail     String?  @map("support_email")
  primaryColor     String?  @map("primary_color")
  logoUrl          String?  @map("logo_url")
  billingSettings  Json?    @map("billing_settings")
  securitySettings Json?    @map("security_settings")
  catalogSettings  Json?    @map("catalog_settings")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model Subscription {
  id                 String             @id @default(cuid())
  plan               SubscriptionPlan   @default(GROWTH)
  status             SubscriptionStatus @default(ACTIVE)
  billingCycle       BillingCycle       @default(MONTHLY) @map("billing_cycle")
  price              Int                @default(3999900)
  currency           String             @default("INR")
  overageRate        Int                @default(29900) @map("overage_rate")
  studentLimit       Int                @default(250) @map("student_limit")
  mentorLimit        Int                @default(20)  @map("mentor_limit")
  cohortLimit        Int                @default(25)  @map("cohort_limit")
  currentPeriodStart DateTime           @default(now()) @map("current_period_start")
  currentPeriodEnd   DateTime           @map("current_period_end")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  @@map("subscriptions")
}
